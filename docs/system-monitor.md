# 系统监控指南

## 目录
1. [功能概述](#功能概述)
2. [安装配置](#安装配置)
3. [监控指标](#监控指标)
4. [告警规则](#告警规则)
5. [使用方法](#使用方法)
6. [性能数据](#性能数据)
7. [日志管理](#日志管理)
8. [故障排除](#故障排除)
9. [最佳实践](#最佳实践)

## 功能概述

系统监控模块提供全面的系统资源监控功能，包括：

- CPU 使用率和负载监控
- 内存和交换空间使用监控
- 磁盘使用率和 IO 性能监控
- 网络接口和连接状态监控
- 进程和服务状态监控
- 系统基础指标监控
- 性能数据历史记录
- 自动清理和维护

## 安装配置

### 基础配置

配置文件位置：`scripts/plugins/monitoring/available/system.monitor`

主要配置项包括：

```bash
# 监控设置
CHECK_INTERVAL=60          # 检查间隔（秒）

# CPU 阈值
MAX_CPU_USAGE=90          # 最大 CPU 使用率（%）
MAX_CPU_LOAD_1=8          # 1分钟最大负载
MAX_CPU_LOAD_5=6          # 5分钟最大负载
MAX_CPU_LOAD_15=4         # 15分钟最大负载

# 内存阈值
MAX_MEMORY_USAGE=90       # 最大内存使用率（%）
MAX_SWAP_USAGE=50         # 最大交换空间使用率（%）
MIN_FREE_MEMORY=1024      # 最小可用内存（MB）

# 磁盘阈值
MAX_DISK_USAGE=90         # 最大磁盘使用率（%）
MIN_FREE_SPACE=10240      # 最小可用空间（MB）
```

### 启用监控

使用以下命令启用系统监控：

```bash
./scripts/plugins/monitoring/commands/enable.sh system
```

## 监控指标

### CPU 监控
- CPU 使用率
- 系统负载（1分钟、5分钟、15分钟）
- IO 等待率
- CPU 被偷取率

### 内存监控
- 总内存使用率
- 可用内存量
- 交换空间使用率
- 页面错误率

### 磁盘监控
- 磁盘空间使用率
- Inode 使用率
- IO 性能统计
- 读写延迟

### 网络监控
- 接口状态
- 带宽使用率
- 错误和丢包统计
- 连接状态

### 进程监控
- 总进程数
- 僵尸进程数
- 线程数
- 文件描述符使用率

### 系统监控
- 运行时间
- 系统熵值
- 上下文切换率
- 中断频率

## 告警规则

系统使用三级告警机制：

1. **正常 (OK)**
   - 所有指标在正常范围内
   - 返回状态码：0

2. **警告 (Warning)**
   - CPU 负载略高
   - 内存使用率接近阈值
   - 磁盘空间接近阈值
   - 返回状态码：2

3. **错误 (Error)**
   - CPU 使用率超过阈值
   - 内存耗尽
   - 磁盘空间耗尽
   - 关键服务停止
   - 返回状态码：1

## 使用方法

### 检查状态

```bash
./scripts/plugins/monitoring/commands/status.sh system
```

输出示例：
```
System Monitor Status Check
==========================
Time: 2024-01-20 10:30:15

CPU Status:
- CPU Usage: 45%
- Load Average: 2.15 (1m), 2.05 (5m), 1.98 (15m)
...

Memory Status:
- Total Memory: 16384 MB
- Used Memory: 8192 MB (50%)
...
```

### 停止监控

```bash
./scripts/plugins/monitoring/commands/disable.sh system
```

## 性能数据

### 数据收集
- 默认启用性能数据收集
- 数据存储位置：`/var/log/system-monitor/history/`
- 保存周期：30天

### 数据格式
每个指标文件包含时间戳和对应的数值：
```
20240120-103015 45.2    # CPU 使用率
20240120-103115 46.1
```

## 日志管理

### 日志文件
- 主日志文件：`/var/log/system-monitor.log`
- 日志级别：info（可配置为 debug、warn、error）
- 日志轮转：每 100MB 轮转一次
- 保留最近 10 个日志文件

### 日志内容
```
2024-01-20 10:30:15 [INFO] System monitor started
2024-01-20 10:30:15 [WARN] High CPU usage: 92%
```

## 故障排除

### 常见问题

1. **监控服务无法启动**
   - 检查配置文件权限
   - 验证日志目录权限
   - 确认所需工具已安装

2. **数据收集失败**
   - 检查磁盘空间
   - 验证目录权限
   - 检查系统工具是否正常

3. **告警误报**
   - 调整告警阈值
   - 检查监控间隔设置
   - 验证系统时间同步

### 调试方法

1. 启用调试日志：
   ```bash
   sed -i 's/LOG_LEVEL="info"/LOG_LEVEL="debug"/' system.monitor
   ```

2. 手动运行状态检查：
   ```bash
   bash -x scripts/plugins/monitoring/available/system.monitor.status
   ```

## 最佳实践

### 配置建议

1. **资源阈值设置**
   - CPU 阈值：根据应用特点设置
   - 内存阈值：预留 20% 空闲
   - 磁盘阈值：预留 15% 空间

2. **监控间隔**
   - 一般系统：60 秒
   - 高负载系统：30 秒
   - 关键系统：15 秒

### 性能优化

1. **数据收集**
   - 适当调整采样间隔
   - 定期清理历史数据
   - 使用合适的日志级别

2. **告警管理**
   - 设置合理的告警阈值
   - 配置告警抑制规则
   - 定期review告警历史

### 安全建议

1. **权限控制**
   - 限制配置文件访问权限
   - 使用专用监控用户
   - 定期轮转日志文件

2. **数据保护**
   - 加密敏感监控数据
   - 定期备份配置文件
   - 保护历史数据目录 