#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 加载配置
source $(dirname "$0")/system.monitor

# 检查必要工具
check_requirements() {
    local missing_tools=()
    
    # 检查系统工具
    for tool in "top" "free" "df" "iostat" "netstat" "ss" "vmstat" "pidstat" "sysctl"; do
        if ! command -v $tool &> /dev/null; then
            missing_tools+=($tool)
        fi
    done

    # 如果缺少工具，安装必要的包
    if [ ${#missing_tools[@]} -gt 0 ]; then
        echo "Installing required tools: ${missing_tools[*]}"
        if command -v apt-get &> /dev/null; then
            apt-get update
            apt-get install -y sysstat net-tools procps
        elif command -v yum &> /dev/null; then
            yum install -y sysstat net-tools procps
        else
            echo -e "${RED}Error: Package manager not found${NC}"
            exit 1
        fi
    fi
}

# 创建目录结构
create_directories() {
    echo "Creating directories..."
    
    # 创建日志目录
    mkdir -p "$(dirname "$LOG_FILE")"
    touch "$LOG_FILE"
    chmod 640 "$LOG_FILE"

    # 创建历史数据目录
    if [ "$ENABLE_PERFORMANCE_HISTORY" = true ]; then
        mkdir -p "$HISTORY_DIR"/{cpu,memory,disk,network,process}
        chmod -R 750 "$HISTORY_DIR"
    fi
}

# 配置日志轮转
configure_log_rotation() {
    echo "Configuring log rotation..."
    cat > /etc/logrotate.d/system-monitor << EOL
$LOG_FILE {
    size $MAX_LOG_SIZE
    rotate $MAX_LOG_FILES
    missingok
    notifempty
    compress
    delaycompress
    create 640 root root
    postrotate
        systemctl reload rsyslog >/dev/null 2>&1 || true
    endscript
}
EOL
}

# 配置系统参数
configure_system_parameters() {
    echo "Configuring system parameters..."
    
    # 配置文件描述符限制
    if ! grep -q "fs.file-max" /etc/sysctl.conf; then
        echo "fs.file-max = 524288" >> /etc/sysctl.conf
    fi

    # 配置网络参数
    cat > /etc/sysctl.d/99-network-tuning.conf << EOL
# 网络调优参数
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 65535
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15
EOL

    # 应用系统参数
    sysctl -p
    sysctl -p /etc/sysctl.d/99-network-tuning.conf
}

# 配置自动清理任务
configure_cleanup_job() {
    if [ "$ENABLE_AUTO_CLEANUP" = true ]; then
        echo "Configuring cleanup job..."
        
        # 创建清理脚本
        cat > /usr/local/bin/system-monitor-cleanup << 'EOL'
#!/bin/bash
source $(dirname "$0")/system.monitor

# 清理旧日志
if [ "$CLEANUP_OLD_LOGS" = true ]; then
    find "$(dirname "$LOG_FILE")" -name "*.gz" -mtime +$MAX_LOG_FILES -delete
fi

# 清理历史数据
if [ "$CLEANUP_OLD_HISTORY" = true ] && [ "$ENABLE_PERFORMANCE_HISTORY" = true ]; then
    find "$HISTORY_DIR" -type f -mtime +$HISTORY_RETENTION_DAYS -delete
fi
EOL

        chmod +x /usr/local/bin/system-monitor-cleanup

        # 添加到 crontab
        echo "0 0 * * * /usr/local/bin/system-monitor-cleanup" > /etc/cron.d/system-monitor
        chmod 644 /etc/cron.d/system-monitor
    fi
}

# 验证监控路径
verify_monitor_paths() {
    echo "Verifying monitored paths..."
    local has_error=0

    for path in "${MONITOR_PATHS[@]}"; do
        if [ ! -e "$path" ]; then
            echo -e "${YELLOW}Warning: Path $path does not exist${NC}"
            has_error=1
        fi
    done

    return $has_error
}

# 验证监控服务
verify_monitor_services() {
    echo "Verifying monitored services..."
    local has_error=0

    for service in "${MONITOR_SERVICES[@]}"; do
        if ! systemctl list-unit-files | grep -q "$service"; then
            echo -e "${YELLOW}Warning: Service $service is not installed${NC}"
            has_error=1
        fi
    done

    return $has_error
}

# 验证监控端口
verify_monitor_ports() {
    echo "Verifying monitored ports..."
    local has_error=0

    for port in "${MONITOR_PORTS[@]}"; do
        if ! ss -tuln | grep -q ":$port "; then
            echo -e "${YELLOW}Warning: Port $port is not listening${NC}"
            has_error=1
        fi
    done

    return $has_error
}

# 主函数
main() {
    echo "Initializing system monitor..."

    # 检查必要工具
    check_requirements

    # 创建目录结构
    create_directories

    # 配置日志轮转
    configure_log_rotation

    # 配置系统参数
    configure_system_parameters

    # 配置自动清理
    configure_cleanup_job

    # 验证配置
    local verify_error=0
    verify_monitor_paths
    [ $? -eq 1 ] && verify_error=1

    verify_monitor_services
    [ $? -eq 1 ] && verify_error=1

    verify_monitor_ports
    [ $? -eq 1 ] && verify_error=1

    if [ $verify_error -eq 0 ]; then
        echo -e "${GREEN}System monitor initialized successfully${NC}"
        exit 0
    else
        echo -e "${YELLOW}System monitor initialized with warnings${NC}"
        exit 2
    fi
}

# 运行主函数
main 