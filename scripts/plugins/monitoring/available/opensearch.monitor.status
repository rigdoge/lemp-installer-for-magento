#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 加载配置
source $(dirname "$0")/opensearch.monitor

# 检查集群健康状态
check_cluster_health() {
    local health=$(curl -s -k -u "monitor:monitor_password" \
        "https://${OPENSEARCH_HOST}:${OPENSEARCH_PORT}/_cluster/health")
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}Error: Cannot get cluster health${NC}"
        return 1
    fi

    local status=$(echo "$health" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
    local active_shards_percent=$(echo "$health" | grep -o '"active_shards_percent":"[^"]*"' | cut -d'"' -f4)
    local initializing_shards=$(echo "$health" | grep -o '"initializing_shards":[^,}]*' | cut -d':' -f2)
    local relocating_shards=$(echo "$health" | grep -o '"relocating_shards":[^,}]*' | cut -d':' -f2)
    local unassigned_shards=$(echo "$health" | grep -o '"unassigned_shards":[^,}]*' | cut -d':' -f2)

    echo "Cluster Health:"
    echo "- Status: $status"
    echo "- Active shards: $active_shards_percent%"
    echo "- Initializing shards: $initializing_shards"
    echo "- Relocating shards: $relocating_shards"
    echo "- Unassigned shards: $unassigned_shards"

    # 检查状态
    if [ "$status" = "red" ]; then
        echo -e "${RED}Error: Cluster status is red${NC}"
        return 1
    elif [ "$status" = "yellow" ]; then
        echo -e "${YELLOW}Warning: Cluster status is yellow${NC}"
        return 2
    fi

    # 检查分片状态
    if [ $(echo "$active_shards_percent < $MIN_ACTIVE_SHARDS" | bc -l) -eq 1 ]; then
        echo -e "${RED}Error: Active shards percentage is too low${NC}"
        return 1
    fi

    if [ $initializing_shards -gt $MAX_INITIALIZING_SHARDS ]; then
        echo -e "${YELLOW}Warning: Too many initializing shards${NC}"
        return 2
    fi

    if [ $relocating_shards -gt $MAX_RELOCATING_SHARDS ]; then
        echo -e "${YELLOW}Warning: Too many relocating shards${NC}"
        return 2
    fi

    if [ $unassigned_shards -gt $MAX_UNASSIGNED_SHARDS ]; then
        echo -e "${RED}Error: Too many unassigned shards${NC}"
        return 1
    fi

    return 0
}

# 检查节点状态
check_node_status() {
    local stats=$(curl -s -k -u "monitor:monitor_password" \
        "https://${OPENSEARCH_HOST}:${OPENSEARCH_PORT}/_nodes/stats")
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}Error: Cannot get node stats${NC}"
        return 1
    fi

    local cpu_usage=$(echo "$stats" | grep -o '"cpu":{[^}]*}' | grep -o '"percent":[^,}]*' | cut -d':' -f2)
    local heap_usage=$(echo "$stats" | grep -o '"heap":{[^}]*}' | grep -o '"percent":[^,}]*' | cut -d':' -f2)
    local disk_usage=$(echo "$stats" | grep -o '"disk":{[^}]*}' | grep -o '"percent":[^,}]*' | cut -d':' -f2)

    echo "Node Status:"
    echo "- CPU Usage: $cpu_usage%"
    echo "- Heap Usage: $heap_usage%"
    echo "- Disk Usage: $disk_usage%"

    # 检查资源使用
    if [ $(echo "$cpu_usage > $MAX_CPU_USAGE" | bc -l) -eq 1 ]; then
        echo -e "${RED}Error: High CPU usage${NC}"
        return 1
    fi

    if [ $(echo "$heap_usage > $MAX_HEAP_USAGE" | bc -l) -eq 1 ]; then
        echo -e "${RED}Error: High heap usage${NC}"
        return 1
    fi

    if [ $(echo "$disk_usage > $MAX_DISK_USAGE" | bc -l) -eq 1 ]; then
        echo -e "${RED}Error: High disk usage${NC}"
        return 1
    fi

    return 0
}

# 检查索引状态
check_index_status() {
    local indices=$(curl -s -k -u "monitor:monitor_password" \
        "https://${OPENSEARCH_HOST}:${OPENSEARCH_PORT}/_cat/indices?format=json")
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}Error: Cannot get index stats${NC}"
        return 1
    fi

    echo "Index Status:"
    local has_warning=0

    while read -r line; do
        local index=$(echo "$line" | grep -o '"index":"[^"]*"' | cut -d'"' -f4)
        local status=$(echo "$line" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
        local size=$(echo "$line" | grep -o '"store\.size":"[^"]*"' | cut -d'"' -f4)
        local docs=$(echo "$line" | grep -o '"docs\.count":[^,}]*' | cut -d':' -f2)

        # 转换大小到 GB
        local size_gb=$(echo "$size" | sed 's/gb//' | sed 's/tb/*1024/' | bc)

        echo "- Index: $index"
        echo "  Status: $status"
        echo "  Size: $size"
        echo "  Documents: $docs"

        if [ "$status" = "red" ]; then
            echo -e "${RED}Error: Index $index is in red status${NC}"
            return 1
        elif [ "$status" = "yellow" ]; then
            echo -e "${YELLOW}Warning: Index $index is in yellow status${NC}"
            has_warning=1
        fi

        if [ $(echo "$size_gb > $MAX_INDEX_SIZE_GB" | bc -l) -eq 1 ]; then
            echo -e "${YELLOW}Warning: Index $index is too large${NC}"
            has_warning=1
        fi

        if [ $docs -lt $MIN_DOC_COUNT ]; then
            echo -e "${YELLOW}Warning: Index $index has few documents${NC}"
            has_warning=1
        fi
    done <<< "$indices"

    [ $has_warning -eq 1 ] && return 2
    return 0
}

# 检查查询性能
check_query_performance() {
    local stats=$(curl -s -k -u "monitor:monitor_password" \
        "https://${OPENSEARCH_HOST}:${OPENSEARCH_PORT}/_nodes/stats/indices")
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}Error: Cannot get query stats${NC}"
        return 1
    fi

    local search_time=$(echo "$stats" | grep -o '"search":{[^}]*}' | grep -o '"query_time_in_millis":[^,}]*' | cut -d':' -f2)
    local index_time=$(echo "$stats" | grep -o '"indexing":{[^}]*}' | grep -o '"index_time_in_millis":[^,}]*' | cut -d':' -f2)

    echo "Query Performance:"
    echo "- Search Latency: ${search_time}ms"
    echo "- Indexing Latency: ${index_time}ms"

    if [ $search_time -gt $MAX_SEARCH_LATENCY ]; then
        echo -e "${YELLOW}Warning: High search latency${NC}"
        return 2
    fi

    if [ $index_time -gt $MAX_INDEXING_LATENCY ]; then
        echo -e "${YELLOW}Warning: High indexing latency${NC}"
        return 2
    fi

    return 0
}

# 主检查逻辑
main() {
    local exit_code=0

    echo "OpenSearch Monitor Status Check"
    echo "=============================="
    echo "Time: $(date)"
    echo

    # 检查集群健康状态
    check_cluster_health
    local result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2

    echo

    # 检查节点状态
    check_node_status
    result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2

    echo

    # 检查索引状态
    check_index_status
    result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2

    echo

    # 检查查询性能
    check_query_performance
    result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2

    echo
    case $exit_code in
        0) echo -e "${GREEN}Status: OK${NC}" ;;
        1) echo -e "${RED}Status: Error${NC}" ;;
        2) echo -e "${YELLOW}Status: Warning${NC}" ;;
    esac

    return $exit_code
}

# 运行检查
main 