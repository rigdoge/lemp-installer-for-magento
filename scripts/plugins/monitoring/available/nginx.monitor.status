#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 加载配置
source $(dirname "$0")/nginx.monitor

# 检查服务状态
check_service_status() {
    if ! systemctl is-active --quiet nginx; then
        echo -e "${RED}Error: Nginx service is not running${NC}"
        return 1
    fi
    return 0
}

# 检查基本状态
check_basic_status() {
    local status=$(curl -s "http://localhost:${NGINX_STATUS_PORT}${NGINX_STATUS_PATH}")
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}Error: Cannot get Nginx status${NC}"
        return 1
    fi

    local active_connections=$(echo "$status" | grep "Active connections" | awk '{print $3}')
    local accepts=$(echo "$status" | awk 'NR==3 {print $1}')
    local handled=$(echo "$status" | awk 'NR==3 {print $2}')
    local requests=$(echo "$status" | awk 'NR==3 {print $3}')
    local reading=$(echo "$status" | awk 'NR==4 {print $2}')
    local writing=$(echo "$status" | awk 'NR==4 {print $4}')
    local waiting=$(echo "$status" | awk 'NR==4 {print $6}')

    echo "Basic Status:"
    echo "- Active connections: $active_connections"
    echo "- Server accepts: $accepts"
    echo "- Server handled: $handled"
    echo "- Server requests: $requests"
    echo "- Reading: $reading"
    echo "- Writing: $writing"
    echo "- Waiting: $waiting"

    # 检查连接数
    if [ $active_connections -gt $MAX_ACTIVE_CONNECTIONS ]; then
        echo -e "${RED}Error: Too many active connections${NC}"
        return 1
    fi

    if [ $waiting -gt $MAX_WAITING_CONNECTIONS ]; then
        echo -e "${YELLOW}Warning: Too many waiting connections${NC}"
        return 2
    fi

    return 0
}

# 检查访问日志
check_access_log() {
    if [ ! -f "$NGINX_ACCESS_LOG" ]; then
        echo -e "${RED}Error: Access log file not found${NC}"
        return 1
    fi

    # 分析最近 5 分钟的日志
    local log_data=$(tail -n 1000 "$NGINX_ACCESS_LOG" | grep "$(date -d '5 minutes ago' +'%d/%b/%Y:%H:%M')")
    
    # 计算请求率
    local request_count=$(echo "$log_data" | wc -l)
    local request_rate=$(( request_count / 5 ))

    # 计算错误率
    local error_count=$(echo "$log_data" | awk '$9 >= 400 {print}' | wc -l)
    local error_rate=$(( error_count * 100 / request_count ))

    # 计算响应时间
    local avg_response_time=$(echo "$log_data" | awk '{sum += $NF} END {print sum/NR}')
    local p95_response_time=$(echo "$log_data" | awk '{print $NF}' | sort -n | awk '{all[NR] = $0} END{print all[int(NR*0.95)]}')
    local p99_response_time=$(echo "$log_data" | awk '{print $NF}' | sort -n | awk '{all[NR] = $0} END{print all[int(NR*0.99)]}')

    echo "Access Log Analysis:"
    echo "- Request rate: $request_rate/sec"
    echo "- Error rate: $error_rate%"
    echo "- Average response time: ${avg_response_time}ms"
    echo "- 95th percentile response time: ${p95_response_time}ms"
    echo "- 99th percentile response time: ${p99_response_time}ms"

    local has_warning=0

    # 检查请求率
    if [ $request_rate -gt $MAX_REQUEST_RATE ]; then
        echo -e "${YELLOW}Warning: High request rate${NC}"
        has_warning=1
    fi

    # 检查错误率
    if [ $error_rate -gt $MAX_ERROR_RATE ]; then
        echo -e "${RED}Error: High error rate${NC}"
        return 1
    fi

    # 检查响应时间
    if [ $(echo "$avg_response_time > $MAX_AVG_RESPONSE_TIME" | bc -l) -eq 1 ]; then
        echo -e "${YELLOW}Warning: High average response time${NC}"
        has_warning=1
    fi

    if [ $(echo "$p95_response_time > $MAX_P95_RESPONSE_TIME" | bc -l) -eq 1 ]; then
        echo -e "${YELLOW}Warning: High P95 response time${NC}"
        has_warning=1
    fi

    if [ $(echo "$p99_response_time > $MAX_P99_RESPONSE_TIME" | bc -l) -eq 1 ]; then
        echo -e "${YELLOW}Warning: High P99 response time${NC}"
        has_warning=1
    fi

    [ $has_warning -eq 1 ] && return 2
    return 0
}

# 检查错误日志
check_error_log() {
    if [ ! -f "$NGINX_ERROR_LOG" ]; then
        echo -e "${RED}Error: Error log file not found${NC}"
        return 1
    fi

    # 分析最近的错误日志
    local recent_errors=$(tail -n 100 "$NGINX_ERROR_LOG")
    local error_count=$(echo "$recent_errors" | grep -c "error")
    local crit_count=$(echo "$recent_errors" | grep -c "crit")
    local alert_count=$(echo "$recent_errors" | grep -c "alert")
    local emerg_count=$(echo "$recent_errors" | grep -c "emerg")

    echo "Error Log Analysis:"
    echo "- Error count: $error_count"
    echo "- Critical count: $crit_count"
    echo "- Alert count: $alert_count"
    echo "- Emergency count: $emerg_count"

    if [ $crit_count -gt 0 ] || [ $alert_count -gt 0 ] || [ $emerg_count -gt 0 ]; then
        echo -e "${RED}Error: Critical errors found in log${NC}"
        return 1
    fi

    if [ $error_count -gt 0 ]; then
        echo -e "${YELLOW}Warning: Errors found in log${NC}"
        return 2
    fi

    return 0
}

# 检查 SSL 证书
check_ssl_certificate() {
    if [ "$CHECK_SSL_EXPIRY" = true ] && [ -f "$SSL_CERT_PATH" ]; then
        local ssl_end_date=$(openssl x509 -enddate -noout -in "$SSL_CERT_PATH" | cut -d= -f2)
        local ssl_days_left=$(( ( $(date -d "$ssl_end_date" +%s) - $(date +%s) ) / 86400 ))

        echo "SSL Certificate:"
        echo "- Days until expiry: $ssl_days_left"

        if [ $ssl_days_left -lt 0 ]; then
            echo -e "${RED}Error: SSL certificate has expired${NC}"
            return 1
        elif [ $ssl_days_left -lt $SSL_EXPIRY_WARN_DAYS ]; then
            echo -e "${YELLOW}Warning: SSL certificate will expire soon${NC}"
            return 2
        fi
    fi
    return 0
}

# 检查缓存状态
check_cache_status() {
    if [ "$MONITOR_CACHE" = true ]; then
        local cache_size=$(du -sh /var/cache/nginx | cut -f1)
        local cache_hit_count=$(grep -c "HIT" "$NGINX_ACCESS_LOG")
        local cache_miss_count=$(grep -c "MISS" "$NGINX_ACCESS_LOG")
        local cache_hit_rate=$(( cache_hit_count * 100 / (cache_hit_count + cache_miss_count) ))

        echo "Cache Status:"
        echo "- Cache size: $cache_size"
        echo "- Cache hit rate: $cache_hit_rate%"

        if [ $cache_hit_rate -lt $MIN_CACHE_HIT_RATE ]; then
            echo -e "${YELLOW}Warning: Low cache hit rate${NC}"
            return 2
        fi
    fi
    return 0
}

# 主检查逻辑
main() {
    local exit_code=0

    echo "Nginx Monitor Status Check"
    echo "========================="
    echo "Time: $(date)"
    echo

    # 检查服务状态
    check_service_status
    [ $? -eq 1 ] && exit_code=1

    echo

    # 如果服务正在运行，执行其他检查
    if [ $exit_code -eq 0 ]; then
        check_basic_status
        local result=$?
        [ $result -eq 1 ] && exit_code=1
        [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2

        echo

        check_access_log
        result=$?
        [ $result -eq 1 ] && exit_code=1
        [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2

        echo

        check_error_log
        result=$?
        [ $result -eq 1 ] && exit_code=1
        [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2

        echo

        check_ssl_certificate
        result=$?
        [ $result -eq 1 ] && exit_code=1
        [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2

        echo

        check_cache_status
        result=$?
        [ $result -eq 1 ] && exit_code=1
        [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2
    fi

    echo
    case $exit_code in
        0) echo -e "${GREEN}Status: OK${NC}" ;;
        1) echo -e "${RED}Status: Error${NC}" ;;
        2) echo -e "${YELLOW}Status: Warning${NC}" ;;
    esac

    return $exit_code
}

# 运行检查
main 