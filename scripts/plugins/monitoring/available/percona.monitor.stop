#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# 加载配置
source $(dirname "$0")/percona.monitor

# 数据库连接函数
mysql_query() {
    mysql -N -s -u"$DB_USER" -p"$DB_PASS" -h"$DB_HOST" -P"$DB_PORT" "$@"
}

# 删除监控用户
remove_monitor_user() {
    echo "删除监控用户..."
    
    # 检查用户是否存在
    local user_exists=$(mysql -N -s -e "SELECT COUNT(*) FROM mysql.user WHERE user='$DB_USER' AND host='$DB_HOST';")
    
    if [ "$user_exists" -gt 0 ]; then
        mysql -e "DROP USER '$DB_USER'@'$DB_HOST';"
        mysql -e "FLUSH PRIVILEGES;"
        echo "已删除监控用户"
    else
        echo "监控用户不存在"
    fi
}

# 禁用慢查询日志
disable_slow_query_log() {
    echo "禁用慢查询日志..."
    
    mysql -e "SET GLOBAL slow_query_log = 0;"
    
    # 删除慢查询日志文件
    if [ -f "$SLOW_QUERY_LOG" ]; then
        rm -f "$SLOW_QUERY_LOG"
        echo "已删除慢查询日志文件"
    fi
    
    # 删除慢查询日志轮转配置
    if [ -f "/etc/logrotate.d/mysql-slow" ]; then
        rm -f "/etc/logrotate.d/mysql-slow"
        echo "已删除慢查询日志轮转配置"
    fi
}

# 清理监控日志和数据
cleanup_monitor_data() {
    echo "清理监控数据..."
    
    # 删除监控日志
    if [ -f "$LOG_FILE" ]; then
        rm -f "$LOG_FILE"
        echo "已删除监控日志文件"
    fi
    
    # 删除日志轮转配置
    if [ -f "/etc/logrotate.d/percona-monitor" ]; then
        rm -f "/etc/logrotate.d/percona-monitor"
        echo "已删除监控日志轮转配置"
    fi
    
    # 删除历史数据目录
    if [ -d "$HISTORY_DIR" ]; then
        rm -rf "$HISTORY_DIR"
        echo "已删除历史数据目录"
    fi
}

# 移除自动清理任务
remove_cleanup_job() {
    echo "移除自动清理任务..."
    
    # 删除清理脚本
    if [ -f "/usr/local/bin/percona-monitor-cleanup" ]; then
        rm -f "/usr/local/bin/percona-monitor-cleanup"
        echo "已删除清理脚本"
    fi
    
    # 删除 cron 任务
    if [ -f "/etc/cron.d/percona-monitor" ]; then
        rm -f "/etc/cron.d/percona-monitor"
        echo "已删除定时清理任务"
    fi
}

# 恢复系统配置
restore_system_config() {
    echo "恢复系统配置..."
    
    # 重置慢查询相关参数
    mysql -e "SET GLOBAL long_query_time = 10;"
    mysql -e "SET GLOBAL log_queries_not_using_indexes = 0;"
    
    echo "已恢复系统配置"
}

# 主函数
main() {
    echo "停止 Percona Server 监控..."
    
    # 删除监控用户
    remove_monitor_user
    
    # 禁用慢查询日志
    disable_slow_query_log
    
    # 清理监控数据
    cleanup_monitor_data
    
    # 移除清理任务
    remove_cleanup_job
    
    # 恢复系统配置
    restore_system_config
    
    echo -e "${GREEN}Percona Server 监控已停止${NC}"
    return 0
}

# 运行主函数
main 