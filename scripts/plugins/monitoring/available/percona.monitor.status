#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 加载配置
source $(dirname "$0")/percona.monitor

# 数据库连接函数
mysql_query() {
    mysql -N -s -u"$DB_USER" -p"$DB_PASS" -h"$DB_HOST" -P"$DB_PORT" "$@"
}

# 检查连接状态
check_connections() {
    echo "连接状态:"
    
    # 获取连接统计
    local conn_status=$(mysqladmin -u"$DB_USER" -p"$DB_PASS" status)
    local current_connections=$(echo "$conn_status" | awk '{print $4}')
    local max_used_connections=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Max_used_connections';" | awk '{print $2}')
    local aborted_connects=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Aborted_connects';" | awk '{print $2}')
    local threads_connected=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Threads_connected';" | awk '{print $2}')
    
    echo "- 当前连接数: $current_connections"
    echo "- 最大使用连接数: $max_used_connections"
    echo "- 失败连接数: $aborted_connects"
    echo "- 活动线程数: $threads_connected"
    
    local has_warning=0
    
    # 检查连接数
    if [ $current_connections -gt $MAX_CONNECTIONS ]; then
        echo -e "${RED}错误: 当前连接数超过最大限制${NC}"
        return 1
    fi
    
    # 检查失败连接
    if [ $aborted_connects -gt $MAX_CONNECT_ERRORS ]; then
        echo -e "${YELLOW}警告: 失败连接数过高${NC}"
        has_warning=1
    fi
    
    [ $has_warning -eq 1 ] && return 2
    return 0
}

# 检查 InnoDB 状态
check_innodb_status() {
    echo "InnoDB 状态:"
    
    # 获取 InnoDB 状态
    local buffer_pool_size=$(mysql_query -e "SHOW VARIABLES LIKE 'innodb_buffer_pool_size';" | awk '{print $2}')
    local buffer_pool_used=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_bytes_data';" | awk '{print $2}')
    local buffer_pool_usage=$(echo "scale=2; $buffer_pool_used * 100 / $buffer_pool_size" | bc)
    
    local buffer_pool_reads=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_reads';" | awk '{print $2}')
    local buffer_pool_read_requests=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_read_requests';" | awk '{print $2}')
    local buffer_pool_hit_rate=$(echo "scale=2; ($buffer_pool_read_requests - $buffer_pool_reads) * 100 / $buffer_pool_read_requests" | bc)
    
    local dirty_pages=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_pages_dirty';" | awk '{print $2}')
    local total_pages=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_pages_total';" | awk '{print $2}')
    local dirty_pages_pct=$(echo "scale=2; $dirty_pages * 100 / $total_pages" | bc)
    
    local row_lock_waits=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Innodb_row_lock_waits';" | awk '{print $2}')
    local row_lock_time_avg=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Innodb_row_lock_time_avg';" | awk '{print $2}')
    
    echo "- 缓冲池使用率: $buffer_pool_usage%"
    echo "- 缓冲池命中率: $buffer_pool_hit_rate%"
    echo "- 脏页比例: $dirty_pages_pct%"
    echo "- 行锁等待次数: $row_lock_waits"
    echo "- 平均锁等待时间: $row_lock_time_avg ms"
    
    local has_warning=0
    
    # 检查缓冲池使用率
    if [ $(echo "$buffer_pool_usage > $MAX_BUFFER_POOL_USAGE" | bc -l) -eq 1 ]; then
        echo -e "${RED}错误: 缓冲池使用率过高${NC}"
        return 1
    fi
    
    # 检查缓冲池命中率
    if [ $(echo "$buffer_pool_hit_rate < $MIN_BUFFER_POOL_HIT" | bc -l) -eq 1 ]; then
        echo -e "${YELLOW}警告: 缓冲池命中率过低${NC}"
        has_warning=1
    fi
    
    # 检查脏页比例
    if [ $(echo "$dirty_pages_pct > $MAX_DIRTY_PAGES_PCT" | bc -l) -eq 1 ]; then
        echo -e "${YELLOW}警告: 脏页比例过高${NC}"
        has_warning=1
    fi
    
    # 检查行锁等待
    if [ $row_lock_waits -gt $MAX_ROW_LOCK_WAITS ]; then
        echo -e "${YELLOW}警告: 行锁等待次数过多${NC}"
        has_warning=1
    fi
    
    [ $has_warning -eq 1 ] && return 2
    return 0
}

# 检查复制状态
check_replication_status() {
    echo "复制状态:"
    
    # 检查是否为从库
    local is_slave=$(mysql_query -e "SHOW SLAVE STATUS\G" | wc -l)
    
    if [ $is_slave -gt 0 ]; then
        local slave_status=$(mysql_query -e "SHOW SLAVE STATUS\G")
        local slave_running=$(echo "$slave_status" | grep "Slave_SQL_Running:" | awk '{print $2}')
        local io_running=$(echo "$slave_status" | grep "Slave_IO_Running:" | awk '{print $2}')
        local seconds_behind=$(echo "$slave_status" | grep "Seconds_Behind_Master:" | awk '{print $2}')
        local relay_log_space=$(echo "$slave_status" | grep "Relay_Log_Space:" | awk '{print $2}')
        local relay_log_space_mb=$(echo "scale=2; $relay_log_space / 1024 / 1024" | bc)
        
        echo "- SQL 线程状态: $slave_running"
        echo "- IO 线程状态: $io_running"
        echo "- 复制延迟: $seconds_behind 秒"
        echo "- 中继日志大小: $relay_log_space_mb MB"
        
        local has_warning=0
        
        # 检查复制状态
        if [ "$slave_running" != "Yes" ] || [ "$io_running" != "Yes" ]; then
            echo -e "${RED}错误: 复制线程未运行${NC}"
            return 1
        fi
        
        # 检查复制延迟
        if [ $seconds_behind -gt $MAX_REPLICATION_LAG ]; then
            echo -e "${YELLOW}警告: 复制延迟过大${NC}"
            has_warning=1
        fi
        
        # 检查中继日志大小
        if [ $(echo "$relay_log_space_mb > $MAX_RELAY_LOG_SPACE" | bc -l) -eq 1 ]; then
            echo -e "${YELLOW}警告: 中继日志空间过大${NC}"
            has_warning=1
        fi
        
        [ $has_warning -eq 1 ] && return 2
    else
        echo "- 该节点不是复制从库"
    fi
    
    return 0
}

# 检查性能指标
check_performance_metrics() {
    echo "性能指标:"
    
    # 获取查询统计
    local questions=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Questions';" | awk '{print $2}')
    local slow_queries=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Slow_queries';" | awk '{print $2}')
    local com_select=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Com_select';" | awk '{print $2}')
    local com_insert=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Com_insert';" | awk '{print $2}')
    local com_update=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Com_update';" | awk '{print $2}')
    local com_delete=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Com_delete';" | awk '{print $2}')
    
    echo "- 总查询数: $questions"
    echo "- 慢查询数: $slow_queries"
    echo "- SELECT 查询: $com_select"
    echo "- INSERT 查询: $com_insert"
    echo "- UPDATE 查询: $com_update"
    echo "- DELETE 查询: $com_delete"
    
    local has_warning=0
    
    # 检查慢查询数
    if [ $slow_queries -gt $MAX_SLOW_QUERIES ]; then
        echo -e "${YELLOW}警告: 慢查询数过多${NC}"
        has_warning=1
    fi
    
    # 获取临时表统计
    local created_tmp_tables=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Created_tmp_tables';" | awk '{print $2}')
    local created_tmp_disk_tables=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Created_tmp_disk_tables';" | awk '{print $2}')
    
    echo "- 临时表数: $created_tmp_tables"
    echo "- 磁盘临时表数: $created_tmp_disk_tables"
    
    # 检查临时表数
    if [ $created_tmp_tables -gt $MAX_TEMP_TABLES ]; then
        echo -e "${YELLOW}警告: 临时表创建数过多${NC}"
        has_warning=1
    fi
    
    if [ $created_tmp_disk_tables -gt $MAX_TEMP_DISK_TABLES ]; then
        echo -e "${YELLOW}警告: 磁盘临时表创建数过多${NC}"
        has_warning=1
    fi
    
    [ $has_warning -eq 1 ] && return 2
    return 0
}

# 检查表空间状态
check_tablespace_status() {
    echo "表空间状态:"
    
    local has_warning=0
    
    # 检查关键表大小
    for table in "${CRITICAL_TABLES[@]}"; do
        local table_size=$(mysql_query -e "SELECT table_name, round(((data_length + index_length) / 1024 / 1024), 2) as size_mb FROM information_schema.tables WHERE table_name='$table';" | awk '{print $2}')
        
        if [ ! -z "$table_size" ]; then
            echo "- 表 $table: $table_size MB"
            
            # 检查表使用率
            if [ $(echo "$table_size > $MAX_TABLE_USAGE" | bc -l) -eq 1 ]; then
                echo -e "${YELLOW}警告: 表 $table 空间使用过大${NC}"
                has_warning=1
            fi
        fi
    done
    
    # 检查 InnoDB 表空间
    local ibdata_size=$(du -m /var/lib/mysql/ibdata1 2>/dev/null | awk '{print $1}')
    if [ ! -z "$ibdata_size" ]; then
        echo "- InnoDB 系统表空间: $ibdata_size MB"
        
        # 检查系统表空间大小
        if [ $ibdata_size -gt $MAX_TABLE_USAGE ]; then
            echo -e "${YELLOW}警告: InnoDB 系统表空间过大${NC}"
            has_warning=1
        fi
    fi
    
    [ $has_warning -eq 1 ] && return 2
    return 0
}

# 检查日志状态
check_log_status() {
    echo "日志状态:"
    
    local has_warning=0
    
    # 检查错误日志
    local error_log=$(mysql_query -e "SHOW VARIABLES LIKE 'log_error';" | awk '{print $2}')
    if [ -f "$error_log" ]; then
        local error_log_size=$(du -m "$error_log" 2>/dev/null | awk '{print $1}')
        echo "- 错误日志大小: $error_log_size MB"
    fi
    
    # 检查慢查询日志
    if [ -f "$SLOW_QUERY_LOG" ]; then
        local slow_log_size=$(du -m "$SLOW_QUERY_LOG" 2>/dev/null | awk '{print $1}')
        echo "- 慢查询日志大小: $slow_log_size MB"
        
        # 检查慢查询日志大小
        if [ $(echo "$slow_log_size > $MAX_SLOW_LOG_SIZE" | bc -l) -eq 1 ]; then
            echo -e "${YELLOW}警告: 慢查询日志过大${NC}"
            has_warning=1
        fi
    fi
    
    # 检查二进制日志
    local binlog_status=$(mysql_query -e "SHOW BINARY LOGS;")
    if [ ! -z "$binlog_status" ]; then
        local binlog_total_size=$(mysql_query -e "SHOW BINARY LOGS;" | awk '{sum += $2} END {print sum/1024/1024}')
        echo "- 二进制日志总大小: $binlog_total_size MB"
    fi
    
    [ $has_warning -eq 1 ] && return 2
    return 0
}

# 保存性能数据
save_performance_data() {
    if [ "$ENABLE_PERFORMANCE_HISTORY" = true ]; then
        local timestamp=$(date +%Y%m%d-%H%M%S)
        
        # 保存连接数据
        local connections=$(mysqladmin -u"$DB_USER" -p"$DB_PASS" status | awk '{print $4}')
        echo "$timestamp $connections" >> "$HISTORY_DIR/connections/count.log"
        
        # 保存 InnoDB 数据
        local buffer_pool_usage=$(mysql_query -e "SELECT (SELECT Innodb_buffer_pool_bytes_data FROM information_schema.GLOBAL_STATUS) * 100 / (SELECT variable_value FROM information_schema.global_variables WHERE variable_name='innodb_buffer_pool_size');" 2>/dev/null)
        echo "$timestamp $buffer_pool_usage" >> "$HISTORY_DIR/innodb/buffer_pool_usage.log"
        
        # 保存查询性能数据
        local queries_per_second=$(mysql_query -e "SHOW GLOBAL STATUS LIKE 'Queries';" | awk '{print $2}')
        echo "$timestamp $queries_per_second" >> "$HISTORY_DIR/performance/queries.log"
        
        # 保存复制延迟数据
        local slave_status=$(mysql_query -e "SHOW SLAVE STATUS\G")
        if [ ! -z "$slave_status" ]; then
            local replication_delay=$(echo "$slave_status" | grep "Seconds_Behind_Master:" | awk '{print $2}')
            echo "$timestamp $replication_delay" >> "$HISTORY_DIR/replication/delay.log"
        fi
    fi
}

# 主检查逻辑
main() {
    local exit_code=0
    
    echo "Percona Server 状态检查"
    echo "======================="
    echo "时间: $(date)"
    echo
    
    # 检查连接状态
    check_connections
    local result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2
    
    echo
    
    # 检查 InnoDB 状态
    check_innodb_status
    result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2
    
    echo
    
    # 检查复制状态
    check_replication_status
    result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2
    
    echo
    
    # 检查性能指标
    check_performance_metrics
    result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2
    
    echo
    
    # 检查表空间状态
    check_tablespace_status
    result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2
    
    echo
    
    # 检查日志状态
    check_log_status
    result=$?
    [ $result -eq 1 ] && exit_code=1
    [ $result -eq 2 ] && [ $exit_code -eq 0 ] && exit_code=2
    
    # 保存性能数据
    save_performance_data
    
    echo
    case $exit_code in
        0) echo -e "${GREEN}状态: 正常${NC}" ;;
        1) echo -e "${RED}状态: 错误${NC}" ;;
        2) echo -e "${YELLOW}状态: 警告${NC}" ;;
    esac
    
    return $exit_code
}

# 运行主函数
main 