#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 加载配置
source $(dirname "$0")/percona.monitor

# 检查 MySQL 服务状态
check_mysql_service() {
    echo "检查 MySQL 服务状态..."
    
    if ! systemctl is-active --quiet mysql; then
        echo "启动 MySQL 服务..."
        systemctl start mysql
        
        # 等待服务启动
        for i in {1..30}; do
            if systemctl is-active --quiet mysql; then
                break
            fi
            sleep 1
        done
    fi
    
    if ! systemctl is-active --quiet mysql; then
        echo -e "${RED}错误: MySQL 服务无法启动${NC}"
        return 1
    fi
    
    echo -e "${GREEN}MySQL 服务运行正常${NC}"
    return 0
}

# 创建监控用户
create_monitor_user() {
    echo "创建监控用户..."
    
    # 检查用户是否已存在
    local user_exists=$(mysql -N -s -e "SELECT COUNT(*) FROM mysql.user WHERE user='$DB_USER' AND host='$DB_HOST';")
    
    if [ "$user_exists" -eq 0 ]; then
        mysql -e "CREATE USER '$DB_USER'@'$DB_HOST' IDENTIFIED BY '$DB_PASS';"
        
        # 授予必要权限
        mysql -e "GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO '$DB_USER'@'$DB_HOST';"
        mysql -e "GRANT SHOW VIEW ON *.* TO '$DB_USER'@'$DB_HOST';"
        mysql -e "FLUSH PRIVILEGES;"
        
        echo -e "${GREEN}监控用户创建成功${NC}"
    else
        echo -e "${YELLOW}监控用户已存在${NC}"
    fi
}

# 配置慢查询日志
configure_slow_query_log() {
    echo "配置慢查询日志..."
    
    # 创建慢查询日志目录
    mkdir -p $(dirname "$SLOW_QUERY_LOG")
    touch "$SLOW_QUERY_LOG"
    chown mysql:mysql "$SLOW_QUERY_LOG"
    
    # 配置慢查询日志参数
    mysql -e "SET GLOBAL slow_query_log = 1;"
    mysql -e "SET GLOBAL slow_query_log_file = '$SLOW_QUERY_LOG';"
    mysql -e "SET GLOBAL long_query_time = $MIN_SLOW_QUERY_TIME;"
    mysql -e "SET GLOBAL log_queries_not_using_indexes = 1;"
    
    echo -e "${GREEN}慢查询日志配置完成${NC}"
}

# 创建监控目录
create_monitor_directories() {
    echo "创建监控目录..."
    
    # 创建日志目录
    mkdir -p "$(dirname "$LOG_FILE")"
    touch "$LOG_FILE"
    chmod 640 "$LOG_FILE"
    
    # 创建历史数据目录
    if [ "$ENABLE_PERFORMANCE_HISTORY" = true ]; then
        mkdir -p "$HISTORY_DIR"/{connections,innodb,replication,performance,tablespaces,logs}
        chmod -R 750 "$HISTORY_DIR"
    fi
    
    # 创建备份目录
    mkdir -p "$BACKUP_DIR"
    chmod 750 "$BACKUP_DIR"
    
    echo -e "${GREEN}监控目录创建完成${NC}"
}

# 配置日志轮转
configure_log_rotation() {
    echo "配置日志轮转..."
    
    # 监控日志轮转
    cat > /etc/logrotate.d/percona-monitor << EOL
$LOG_FILE {
    size $MAX_LOG_SIZE
    rotate $MAX_LOG_FILES
    missingok
    notifempty
    compress
    delaycompress
    create 640 root root
    postrotate
        systemctl reload rsyslog >/dev/null 2>&1 || true
    endscript
}
EOL

    # 慢查询日志轮转
    cat > /etc/logrotate.d/mysql-slow << EOL
$SLOW_QUERY_LOG {
    size $MAX_SLOW_LOG_SIZE
    rotate 5
    missingok
    notifempty
    compress
    delaycompress
    create 640 mysql mysql
    postrotate
        systemctl reload mysql >/dev/null 2>&1 || true
    endscript
}
EOL

    echo -e "${GREEN}日志轮转配置完成${NC}"
}

# 配置自动清理任务
configure_cleanup_job() {
    if [ "$ENABLE_AUTO_CLEANUP" = true ]; then
        echo "配置自动清理任务..."
        
        # 创建清理脚本
        cat > /usr/local/bin/percona-monitor-cleanup << 'EOL'
#!/bin/bash
source $(dirname "$0")/percona.monitor

# 清理旧日志
if [ "$CLEANUP_OLD_LOGS" = true ]; then
    find "$(dirname "$LOG_FILE")" -name "*.gz" -mtime +$MAX_LOG_FILES -delete
    find "$(dirname "$SLOW_QUERY_LOG")" -name "*.gz" -mtime +5 -delete
fi

# 清理历史数据
if [ "$CLEANUP_OLD_HISTORY" = true ] && [ "$ENABLE_PERFORMANCE_HISTORY" = true ]; then
    find "$HISTORY_DIR" -type f -mtime +$HISTORY_RETENTION_DAYS -delete
fi
EOL

        chmod +x /usr/local/bin/percona-monitor-cleanup
        
        # 添加到 crontab
        echo "0 0 * * * /usr/local/bin/percona-monitor-cleanup" > /etc/cron.d/percona-monitor
        chmod 644 /etc/cron.d/percona-monitor
        
        echo -e "${GREEN}自动清理任务配置完成${NC}"
    fi
}

# 验证监控配置
verify_monitor_config() {
    echo "验证监控配置..."
    local has_error=0
    
    # 验证数据库连接
    if ! mysql -u"$DB_USER" -p"$DB_PASS" -h"$DB_HOST" -P"$DB_PORT" -e "SELECT 1;" &>/dev/null; then
        echo -e "${RED}错误: 无法连接到数据库${NC}"
        has_error=1
    fi
    
    # 验证关键表存在
    for table in "${CRITICAL_TABLES[@]}"; do
        if ! mysql -u"$DB_USER" -p"$DB_PASS" -h"$DB_HOST" -P"$DB_PORT" -e "SHOW TABLES LIKE '$table';" &>/dev/null; then
            echo -e "${YELLOW}警告: 表 $table 不存在${NC}"
            has_warning=1
        fi
    done
    
    # 验证必要工具
    for tool in "$STATUS_SCRIPT" "$PROCESS_SCRIPT"; do
        if [ ! -x "$tool" ]; then
            echo -e "${RED}错误: 工具 $tool 不存在或不可执行${NC}"
            has_error=1
        fi
    done
    
    return $has_error
}

# 主函数
main() {
    echo "初始化 Percona Server 监控..."
    
    # 检查 MySQL 服务
    check_mysql_service || exit 1
    
    # 创建监控用户
    create_monitor_user
    
    # 配置慢查询日志
    configure_slow_query_log
    
    # 创建监控目录
    create_monitor_directories
    
    # 配置日志轮转
    configure_log_rotation
    
    # 配置自动清理
    configure_cleanup_job
    
    # 验证配置
    verify_monitor_config
    local verify_result=$?
    
    if [ $verify_result -eq 0 ]; then
        echo -e "${GREEN}Percona Server 监控初始化成功${NC}"
        exit 0
    else
        echo -e "${RED}Percona Server 监控初始化失败${NC}"
        exit 1
    fi
}

# 运行主函数
main 