#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SMTP_SCRIPT="$SCRIPT_DIR/../../../smtp/smtp_send.sh"

# 加载配置
source "$SCRIPT_DIR/rabbitmq.monitor"

# 发送告警邮件
send_alert_email() {
    local status="$1"
    local message="$2"
    
    if [ "$ENABLE_EMAIL_ALERT" = "true" ] && [ -f "$SMTP_SCRIPT" ]; then
        local subject="$ALERT_EMAIL_SUBJECT - $status"
        local body="RabbitMQ 监控告警\n\n状态: $status\n时间: $(date '+%Y-%m-%d %H:%M:%S')\n\n$message"
        
        "$SMTP_SCRIPT" "$ALERT_EMAIL_TO" "$subject" "$body" || {
            echo -e "${RED}错误：邮件发送失败${NC}"
            return 1
        }
    fi
}

# 检查 RabbitMQ 状态
check_rabbitmq_status() {
    local status_message=""
    local has_error=false
    
    # 检查服务状态
    if ! systemctl is-active --quiet rabbitmq-server; then
        status_message="RabbitMQ 服务未运行"
        has_error=true
        send_alert_email "错误" "$status_message"
        echo -e "${RED}错误：$status_message${NC}"
        exit 1
    fi
    
    # 检查队列状态
    local queue_status=$(rabbitmqctl list_queues name messages consumers 2>/dev/null)
    if [ $? -ne 0 ]; then
        status_message="无法获取队列信息"
        has_error=true
        send_alert_email "错误" "$status_message"
        echo -e "${RED}错误：$status_message${NC}"
        exit 1
    fi
    
    # 分析队列状态
    while read -r queue messages consumers; do
        if [ "$queue" != "Listing" ] && [ -n "$queue" ]; then
            if [ $messages -gt $MAX_QUEUE_SIZE ]; then
                status_message="队列 $queue 消息数量过多: $messages (超过 $MAX_QUEUE_SIZE)"
                has_error=true
                send_alert_email "警告" "$status_message"
                echo -e "${YELLOW}警告：$status_message${NC}"
            fi
            
            if [ $consumers -lt $MIN_CONSUMERS ]; then
                status_message="队列 $queue 消费者数量不足: $consumers (少于 $MIN_CONSUMERS)"
                has_error=true
                send_alert_email "警告" "$status_message"
                echo -e "${YELLOW}警告：$status_message${NC}"
            fi
        fi
    done <<< "$queue_status"
    
    # 检查内存使用
    local memory_usage=$(rabbitmqctl status 2>/dev/null | grep -A 5 "Memory" | grep "total" | awk '{print $2}')
    local total_memory=$(free -m | grep "Mem:" | awk '{print $2}')
    local memory_percent=$((memory_usage * 100 / total_memory))
    
    if [ $memory_percent -gt $MAX_MEMORY_USAGE ]; then
        status_message="内存使用率过高: ${memory_percent}% (超过 ${MAX_MEMORY_USAGE}%)"
        has_error=true
        send_alert_email "警告" "$status_message"
        echo -e "${YELLOW}警告：$status_message${NC}"
    fi
    
    if [ "$has_error" = false ]; then
        echo -e "${GREEN}RabbitMQ 状态正常${NC}"
        exit 0
    else
        exit 2
    fi
}

# 执行状态检查
check_rabbitmq_status
