#!/bin/bash

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 检查 rabbitmqctl 是否可用
if ! command -v rabbitmqctl &> /dev/null; then
    echo "Error: rabbitmqctl not found"
    exit 1
fi

# 检查服务状态
if ! systemctl is-active --quiet rabbitmq-server; then
    echo "Status: Service is not running"
    exit 1
fi

# 获取队列信息
QUEUE_INFO=$(rabbitmqctl list_queues name messages consumers 2>/dev/null)
if [ $? -ne 0 ]; then
    echo "Error: Failed to get queue information"
    exit 1
fi

# 获取节点状态
NODE_STATUS=$(rabbitmqctl status 2>/dev/null)
if [ $? -ne 0 ]; then
    echo "Error: Failed to get node status"
    exit 1
fi

# 解析内存使用情况
MEMORY_USED=$(echo "$NODE_STATUS" | grep -A 5 "Memory" | grep "total" | awk '{print $2}')
MEMORY_LIMIT=$(echo "$NODE_STATUS" | grep -A 5 "Memory" | grep "limit" | awk '{print $2}')

# 计算队列统计信息
TOTAL_QUEUES=$(echo "$QUEUE_INFO" | tail -n +2 | wc -l)
TOTAL_MESSAGES=$(echo "$QUEUE_INFO" | tail -n +2 | awk '{sum += $2} END {print sum}')
TOTAL_CONSUMERS=$(echo "$QUEUE_INFO" | tail -n +2 | awk '{sum += $3} END {print sum}')

# 检查警告条件
WARNING=0
ERROR=0

# 检查队列积压
if [ $TOTAL_MESSAGES -gt 1000 ]; then
    WARNING=1
fi

# 检查消费者
if [ $TOTAL_CONSUMERS -eq 0 ] && [ $TOTAL_QUEUES -gt 0 ]; then
    ERROR=1
fi

# 输出状态信息
echo "Queues: $TOTAL_QUEUES"
echo "Total Messages: $TOTAL_MESSAGES"
echo "Active Consumers: $TOTAL_CONSUMERS"
echo "Memory Used: $MEMORY_USED"
echo "Memory Limit: $MEMORY_LIMIT"

# 检查是否有无消费者的队列
QUEUES_WITHOUT_CONSUMERS=$(echo "$QUEUE_INFO" | tail -n +2 | awk '$3 == 0 {print $1}')
if [ ! -z "$QUEUES_WITHOUT_CONSUMERS" ]; then
    echo -e "\nQueues without consumers:"
    echo "$QUEUES_WITHOUT_CONSUMERS"
fi

# 检查是否有消息积压的队列
QUEUES_WITH_MESSAGES=$(echo "$QUEUE_INFO" | tail -n +2 | awk '$2 > 100 {print $1 ": " $2 " messages"}')
if [ ! -z "$QUEUES_WITH_MESSAGES" ]; then
    echo -e "\nQueues with high message count:"
    echo "$QUEUES_WITH_MESSAGES"
fi

# 返回状态码
if [ $ERROR -eq 1 ]; then
    exit 1  # 错误状态
elif [ $WARNING -eq 1 ]; then
    exit 2  # 警告状态
else
    exit 0  # 正常状态
fi
